#CONTROLCODES 1
#SYMFILE "@:HANGMANB.SYM"

STARTUP:
DIM S$,F$,DCHAR%(9),NV$(18),NN$(18),NV%,FV%,TC%(2,8),AL%(4,26),PC%(8,4),MC$(5),DI$(3),PL%(2,1),PL$(2),WN%(2)
DIM MUSIC.NAME$(3),ZNUM%(3),USING.LST%(3),ZSM.RANDOM%(3),MUSIC.PAUSED%(3):LS%=-1:X=RND(-RND(.))
GOSUB SETREGVARS:GOSUB SETUPTEXTMODE:POKE C.REG,1:SYS $FF99:LAST.BANK = PEEK(A.REG):IF LAST.BANK=0 THEN LAST.BANK=256
LAST.BANK=LAST.BANK-1:GRAPH.BANK=LAST.BANK-11


## HERE I'M GETTING THE COMMUNICATION SIGNATURES FROM MY
## SUB MODULES.
GOSUB GETFROMMENU:ADDR=$500:GOSUB GETZPSTRING:I=PEEK($400):X=PEEK($401):C=PEEK($402):J=PEEK($403):C1=(I=$FF)AND(X=$EC)AND(C=$FF)AND(J=$FE)

## FILESCHECKED=TRUE MEANS I'VE BEEN LOADED BACK FROM
## FILECHECKER R15H IS A BIT ENCODED VARIABLE
## TELLING ME WHAT FILES ARE PRESENT
## R15L WILL HOLD COUNT OF WORD FILES
## ONLY SET THE GRAPHICS MODE ON THE FIRST RUN
IF C1 THEN FFLAGS=PEEK(R15H):FC%=PEEK(R15L)
POKE C.REG,1:SYS $FF5F:IF PEEK(A.REG)<>$80 THEN SCREEN $80:RECT 0,0,319,239,$C1

IF NOT C1 THEN F$="CHECKLOAD":GOTO LOADER

F$="HANGMAN.INI":PASS2=(LEFT$(ZP.STRING$,3)="ZSM")

  IF PASS2 THEN ADDR=$525:X$=ZP.STRING$:GOSUB GETZPSTRING:GO1=(ZP.STRING$="GOGOGO"):ZP.STRING$=X$:IF GO1 THEN SKIPMSGS
  IF NOT PASS2 THEN CLS:PRINT "{CR}{YEL} INITIALIZATION{GRN}...{CR}{CR}";FC%;"{WHT} WORD FILES{CR}{CR} FFLAGS: {GRN}";BIN$(FFLAGS);"{WHT}"
  MOUSE 1:PRINT "{CR} {YEL}READING: {WHT}";F$;"{GRN}";:GOSUB READINI
SKIPMSGS:
  IF GO1 THEN CLS:GOSUB READINIFROMBANK

  I$="USEZSM":GOSUB GETINIVALUE:IF I$="0" THEN UZSM%=0:GOTO MAIN2
  IF LEFT$(ZP.STRING$,3)<>"ZSM" THEN DOZSMLOAD
  UZSM%=(ZP.STRING$="ZSMLOADED"):GOTO MAIN2

DOZSMLOAD:
  POKE R15L,FC%:POKE R15H,FFLAGS:F$="ZSMLOADER":GOTO LOADER

MAIN2:
  I$="FASTBLIT":GOSUB GETINIVALUE:NO.FASTBLIT=(I$="0")
  I$="DRAWPARTS":GOSUB GETINIVALUE:FORCEDRAW=(I$="1")
  PF$="DPAL.BIN":I$="PALFILE":GOSUB GETINIVALUE:F$=I$:GOSUB FILEEXISTS:IF FE% THEN PF$=I$:IN.GAME=0
  I$="FORCEPETSCII":GOSUB GETINIVALUE:IF I$="1" THEN PRINT "{ISO OFF}{UPPER}{CHARSET SWITCH OFF}":GOTO SKIPISOLOAD
  I$="FORCEISO":GOSUB GETINIVALUE:IF I$="1" THEN PRINT "{ISO ON}"

SKIPISOLOAD:
## CLEAR OUR FLAGS STUFF OUT OF GOLDENRAM
  GOSUB SETUPTEXTMODE:GOSUB INITMUSICFILES:GOSUB VARINIT:GOTO GAMEMENU


BLOCKSMILE:
  GOSUB BLOCKFROWN:VPOKE 1,FBASE+4,$BD:VPOKE 1,FBASE+5,$C3:RETURN

BLOCKFROWN:
  FBASE=$F2F0:IF ISO.ON THEN FBASE=$F7F8
  VPOKE 1,FBASE,$3C:VPOKE 1,FBASE+1,$7E:VPOKE 1,FBASE+2,$DB:VPOKE 1,FBASE+3,$FF:VPOKE 1,FBASE+4,$C3:VPOKE 1,FBASE+5,$BD:VPOKE 1,FBASE+6,$7E:VPOKE 1,FBASE+7,$3C:RETURN

GAMEMENU:
  GOSUB CLSGRAPH:GOSUB SETDRAWPAL:S$="HANGMAN Game Menu":GOSUB GMENUBACK:IN.GAME=0
  IF CH<1 OR CH>5 THEN CH=1
  X=5:Y=4:DI=2:FOR I=1 TO 4:Y=Y+3:LOCATE Y,X:COLOR 1,0:PRINT RIGHT$(STR$(I),1);:PRINT ":{PUR}"MC$(I);:NEXT I
  W=34:H=14:C1=1:C2=$17:C3=$C2:C4=$1E:L$="ENTER":X=28:Y=155:GOSUB DRAWBTN:LOCATE 21,9:S$="{PUR}To Confirm Choice":GOSUB PETCHK:LOCATE 24,20:S$="{PUR}Difficulty:{WHT}"+DI$(DI)
  GOSUB PETCHK:W=18:H=12:L$="<-":X=201:Y=195:GOSUB DRAWBTN:X=226:L$="->":GOSUB DRAWBTN:GOSUB FLUSHKEYS:GOSUB ZSMGETSTATE:IF ZSM.IS.PLAYING THEN LOOP.ON=0:GOSUB SETZSMLOOP

MENUSHOW:
  IF CH=4 THEN Y=16
  IF CH=3 THEN Y=13
  IF CH=2 THEN Y=10
  IF CH=1 THEN Y=7
  LOCATE Y,5:COLOR 7,4:PRINT CHR$(DCHAR%(9));" ";:PRINT"{WHT}";MC$(CH);RPT$(32,27-LEN(MC$(CH)));:COLOR 1,0:LOCATE 24,31:PRINT RPT$(32,10);:LOCATE 24,31:PRINT DI$(DI);:GOSUB SHOWALL

MENUGET:
  GET X$:RA=MWHEEL:IF MB<>1 AND RA=0 THEN SKIPMOUSE3
  CX=MX:CY=MY:I=1:MC%=0

CHKMOUSE:
  IF RA<0 THEN X$=CHR$(145)
  IF RA>0 THEN X$=CHR$(17)
  IF X$<>"" THEN ENDMOUSE
  MC%=(CX>=PC%(I,1)) AND (CX<=PC%(I,3)) AND (CY>=PC%(I,2)) AND (CY<=PC%(I,4))
  IF NOT MC% THEN I=I+1:IF I>8 THEN X$="Z":GOTO ENDMOUSE
  IF NOT MC% THEN CHKMOUSE
  IF I<5 THEN X$=RIGHT$(STR$(I),1)
  IF I=5 THEN X$="{CR}"
  IF I=6 THEN X$=CHR$(157)
  IF I=7 THEN X$=CHR$(29)
ENDMOUSE:
  IF MB<>0 THEN ENDMOUSE

SKIPMOUSE3:
  IF X$="" THEN MENUGET
  CX=ASC(X$):IF CX<>29 AND CX<>157 THEN GOSUB CLICK
  LOCATE Y,5:COLOR 1,0:PRINT RIGHT$(STR$(CH),1);:PRINT ":{PUR}"MC$(CH);RPT$(32,28-LEN(MC$(CH)));
  IF CH=4 AND CX=27 THEN CX=13
  IF CX=27 THEN CH=4
  IF CX>=49 AND CX<=53 THEN CH=VAL(X$)
  IF CX=145 THEN CH=CH-1
  IF CX=17 THEN CH=CH+1
  IF CX=157 THEN DI=DI-1:X=201:L$="<-"
  IF CX=29 THEN DI=DI+1:X=226:L$="->"
  IF CX=29 OR CX=157 THEN Y=195:W=18:H=12
  IF CX=13 THEN L$="ENTER":W=34:H=14:X=28:Y=155
  IF CX=29 OR CX=157 OR CX=13 THEN GOSUB PUSHBTN
  IF CX=13 THEN STARTGAME
  IF CH>4 THEN CH=1
  IF CH<1 THEN CH=4
  IF DI>3 THEN DI=1
  IF DI<1 THEN DI=3
  GOTO MENUSHOW

STARTGAME:
    IF CH=4 THEN CLEANUP
    IN.GAME=TRUE:GOSUB PLAYERNAMES:ROUND=1:CP%=1:WN%(1)=0:WN%(2)=0
LETSGO:
    ZS=2:GOSUB PLAYSONG:NE%=-1:COLOR 1,0:CLS
    IF CH=1 OR CH=2 THEN PLAYCOMP
    IF CH=3 THEN HEAD2HEAD

PLAYCOMP:
    GOSUB WORDFROMFILE:GOTO HANGMAN
HEAD2HEAD:
    GOSUB PLAYERWORD:COMPLETE.DRAW=TRUE:GOSUB CLSGRAPH

HANGMAN:
    IF COMPLETE.DRAW THEN GOSUB HIDETEXT
    GOSUB SCORECARD:GOSUB GAMEBOARD:GOSUB FLUSHKEYS:GOSUB SHOWALL

HANDLEINPUT:
    GOSUB GETCHARX:HF%=0:IF X$=CHR$(27) THEN GOSUB EXITCHECK:GOSUB FLUSHKEYS
    IF HF% THEN IF UZSM% THEN LOOP.ON=0:GOSUB SETZSMLOOP
    IF HF% THEN GAMEMENU
    IF MB=1 THEN HNDLMOUSE
    IF X$="" THEN HANDLEINPUT
    GOTO SKIPMOUSE2
HNDLMOUSE:
    CX=MX:CY=MY:X=1:H1=0:X$="":IF CY>131 THEN X=15

    ## X1=AL%(3,X):X2=X1+14:Y1=AL%(4,X):Y2=Y1+14:IF CX>=X1 AND CX<=X2 AND CY>=Y1 AND CY<=Y2 THEN X$=CHR$(AL%(2,X)):H1=1
NEXTBTN:
    IF CX>=AL%(3,X) AND CX<=AL%(3,X)+14 AND CY>=AL%(4,X) AND CY<=AL%(4,X)+14 THEN X$=CHR$(AL%(2,X)):H1=1
    IF H1=0 AND X<26 THEN X=X+1:GOTO NEXTBTN
RELEASEMOUS:
    IF MB<>0 THEN RELEASEMOUS
    IF H1 THEN SKIPMOUSE2
    LOCATE 1,1:GOSUB BOING:GOTO HANDLEINPUT

SKIPMOUSE2:
    LL=ASC(X$):IF LL=32 THEN HANDLEINPUT
    IF LL<65 OR LL>90 THEN GOSUB BOING:GOTO HANDLEINPUT
    A=LL-64:IF AL%(1,A)=1 THEN GOSUB BOING:GOTO HANDLEINPUT
    CL$=CHR$(LL):H=14:W=14:X=AL%(3,A):Y=AL%(4,A):L$=CHR$(LL):GOSUB PUSHBTN:HF%=0:GOSUB CHECKLETTER
    IF HF% THEN GOSUB WORDBOX:GOSUB DRUMROLL:IF HW$=DW$ THEN COMPLETE.DRAW=FALSE:GOTO WONROUND
    IF NOT HF% THEN NE%=0:GOSUB BODYPART:GOSUB PARTSCOUNT
    IF LF% THEN COMPLETE.DRAW=FALSE:GOTO LOSTROUND
    SLEEP 10:GOSUB DISABLEBTN:GOTO HANDLEINPUT

WONROUND:
  WN%(CP%)=WN%(CP%)+1:PL%(CP%,1)=PL%(CP%,1)+1:IF NE% THEN S$="FLAW":I$=" LESS":WN%(CP%)=0:GOSUB BIGWINANIM:GOTO WON2
  IF WN%(CP%)/5=INT(WN%(CP%)/5) THEN S$=RIGHT$(STR$(WN%(CP%)),LEN(STR$(WN%(CP%)))-1)+" in":I$="a Row":GOSUB BIGWINANIM:GOTO WON2
  GOSUB GAMEMSG:COLOR 7,4:LOCATE 16,21:PRINT "YOU WON {WHT}!":GOSUB PLAYFANFARE:GOSUB SUNSMILE
WON1:
  IF ZTIMER > TI THEN WON1
  ZTIMER=0:GOSUB POPSONG
WON2:
  GOSUB FLUSHKEYS:GOSUB ADVROUND:GOTO LETSGO

LOSTROUND:
  DW$=HW$:GOSUB WORDBOX:WN%(CP%)=0:GOSUB LOSSSCREEN:GOSUB ADVROUND:GOSUB SWAPSONGBACK:CLS:GOSUB SETDRAWPAL:GOTO LETSGO

ADVROUND:
  LF%=0:HF%=0:IF CH=1 THEN ROUND=ROUND+1:RETURN
  IF CP%=2 THEN ROUND=ROUND+1:CP%=1:RETURN
  IF CP%=1 THEN CP%=2:RETURN

EXITCHECK:
  GOSUB GAMEMSG:COLOR 1,4:LOCATE 15,19:PRINT "BACK TO MENU";:LOCATE 18,23:PRINT "{YEL}Y";:PRINT "{WHT}/{YEL}N {WHT}?";
CHKLOOP:
  GOSUB GETCHARX:IF X$="" THEN CHKLOOP
  IF X$="Y" THEN HF%=-1
  IF X$="Y" OR X$="N" OR X$=CHR$(27) THEN ENDCHK
  GOSUB BOING:GOTO CHKLOOP
ENDCHK:
  GOSUB FLUSHKEYS:COLOR 0,0:X=16:Y=12:H=11:W=18:GOSUB TEXTBOX:COLOR 1:RETURN

GETCHARX:
   GOSUB MANAGEMUSIC
GETCHRX:
   GET X$:X=ASC(X$):GOSUB ADJUSTPETLOWER:IF ISO.ON THEN IF X>=97 AND X<=122 THEN X=X-32:X$=CHR$(X)
   J=MWHEEL:IF J<0 THEN X=145
   IF J>0 THEN X=17
   IF VVIS THEN IF TI>VTIMER THEN GOSUB HIDEVOLUME
   IF X=145 THEN VOLUME=VOLUME+2:GOSUB SETVOLUME:X$=""
   IF X=17 THEN VOLUME=VOLUME-2:GOSUB SETVOLUME:X$=""
   IF X=32 THEN IF MUSIC.PAUSED%(ZS) THEN STARTMUSIC
   IF X=32 THEN PAUSEMUSIC
   IF X=23 THEN GOSUB PAUSEMUSIC:MUSIC.PAUSED%(ZS)=FALSE:X$=""
   IF X=135 THEN X$="":GOTO BLITSUB
   RETURN

BLITSUB:
  IF FORCEDRAW THEN FORCEDRAW=0:NO.FASTBLIT=TRUE:RETURN
  IF NO.FASTBLIT THEN NO.FASTBLIT=FALSE:RETURN
  IF NOT NO.FASTBLIT THEN FORCEDRAW=TRUE:RETURN

ADJUSTPETLOWER:
 IF X>=193 AND X<=218 THEN X=X-128:X$=CHR$(X)
 RETURN

SETVOLUME:
##  Inputs: .X = priority, .A = attenuation value
  IF UZSM% THEN DOZVOLUME
  RETURN
DOZVOLUME:
  IF VOLUME < 0 THEN VOLUME=0
  IF VOLUME > 100 THEN VOLUME=100
  GOSUB SHOWVOLUME
SETITNOW:
  ZCVOLUME=INT((VOLUME/100)*12+.5):POKE X.REG, ZNUM%(ZS):POKE A.REG, 63-INT((VOLUME/100*63)+.5):SYS $8C21:RETURN

SHOWVOLUME:
   IF VVIS THEN SKIPFRAME
   FRAME 295,7,301,208,BLACK2:RECT 293,208,303,210,BLACK2
SKIPFRAME:
   Y1=(100-VOLUME)*2:Y2=VOLUME*2:IF Y1>0 THEN RECT 296,8,300,7+Y1,$C0
   IF Y2>0 THEN RECT 296,8+Y1,300,207,$37
   LOCATE 21,29:PRINT "    ";:VVIS=TRUE:LOCATE 21,29:PRINT "{YEL}";MID$(STR$(VOLUME),2);"%";:VTIMER=TI+300:RETURN

HIDEVOLUME:
  VVIS=FALSE:RECT 295,2,301,166,$C0:LOCATE 21,29:PRINT "    ";:X1=290:Y1=166:BLITLINES=46:BLITWIDTH=15:F$="UNDER.DAT":GOTO GRAPHBLITIMAGE

GAMEMSG:
  COLOR 4,6:X=16:Y=12:H=11:W=18:GOSUB TEXTBOX:COLOR 7,4:X=17:Y=13:H=9:W=16:GOTO TEXTBOX

BODYPART:
  GOSUB BOING:LF%=0:GOSUB DRAWMASK:ON BP GOSUB DRWLEFTLEG, DRWRIGHTLEG, DRWLEFTARM, DRWRIGHTARM, DRWTORSO, DRAWFACE, DRAWNOOSE, DRAWGALLOWS:GOSUB SHOWCLUE:BP=BP-1:IF BP=0 THEN LF%=-1
  GOTO ENDCHK

DRAWMASK:
  ## GOSUB PLAYSONG:LOOP.ON=0:GOSUB SETZSMLOOP
  J=$76:IF ISO.ON THEN J=177
  COLOR 6,0:FOR Y=13 TO 21:LOCATE Y,17:PRINT RPT$(J,16);:NEXT Y:COLOR 7,4:LOCATE 17,20:PRINT "DRAWING  !!";:COLOR 4,0:RETURN

GAMEBOARD:
  IF COMPLETE.DRAW THEN COLOR 1,0:GOSUB SETDRAWPAL
  BP=9-DI:GOSUB BACKGROUND:IF DI>1 THEN GOSUB DRAWGALLOWS
  IF DI=3 THEN GOSUB DRAWNOOSE
  DW$=""
  FOR I=1 TO LEN(HW$):X$=MID$(HW$,I,1):IF ASC(X$)>=65 AND ASC(X$)<=90 THEN DW$=DW$+CHR$(DCHAR%(9)):GOTO SKIP5
    DW$=DW$+X$
SKIP5:
  NEXT I
  GOSUB WORDBOX:GOSUB PARTSCOUNT:GOSUB SHOWTEXT:GOSUB LETTERPANL:MOUSE 1:GOTO SHOWCLUE

WORDBOX:
  J=LEN(HW$):COLOR 4,6:X=17+(7-J/2):Y=5:H=3:W=LEN(HW$)+2:GOSUB TEXTBOX:LOCATE 6,18+(7-J/2)
  FOR I=1 TO J:IF ASC(MID$(DW$,I,1))=DCHAR%(9) THEN PRINT "{YEL}";:GOTO PCHAR;
    PRINT "{WHT}";
   PCHAR:
    PRINT MID$(DW$,I,1);:NEXT I:RETURN

SHOWCLUE:
  COLOR 1,0:IF NOT UC% THEN CLRMSG
  S$=HC$:GOTO PLAINMSG

CHECKLETTER:
  L=LEN(HW$):X$=""
  FOR X=1 TO L:C$=MID$(HW$,X,1):IF C$=CL$ THEN X$=X$+CL$:HF%=-1:GOTO SKIP8
    X$=X$+MID$(DW$,X,1)
SKIP8:
  NEXT X:DW$=X$:RETURN

SCORECARD:
  LOCATE 1,14:PRINT "{BLUE}";PL$(CP%);:PRINT "{PUR} PLAYING";:LOCATE 2,14:PRINT "{PUR} WINS:";:PRINT "{RED}";PL%(CP%,1);"  ";
  PRINT "{PUR}LOSSES:";:PRINT "{RED}";(ROUND-1)-PL%(CP%,1);:LOCATE 26,25:S$="{WHT}Round:{YEL}"+STR$(ROUND):GOTO PETCHK

DRUMROLL:
  ZCM.NUMBER=0:GOTO ZCMPLAY

PLAYERWORD:
     GOSUB CLSGRAPH:P1=5:R%=0:B%=0:G%=4:GOSUB RGBPAL:COMPLETE.DRAW=TRUE
     IF CP%=1 THEN CY=2:O=1
     IF CP%=2 THEN CY=1:O=2
     S$="Game Word and Clue for your Opponent":GOSUB GMENUBACK:LOCATE 8,4:PRINT "{BLUE}";PL$(CY);:LOCATE 10,5:PRINT "{PUR}ENTER WORD";
     LOCATE 12,5:PRINT "FOR {GRN}";PL$(O);" {PUR}TO PLAY"
PENTERWORD:
     LOCATE 14,4:PRINT "{WHT}==";:PRINT "{RED}> ";: GOSUB SHOWALL
     Y=14:X=8:IT=1:ML=15:COLOR 7,4:GOSUB STRINGGET:IF LEN(I$)>0 THEN GOTAWORD
     GOSUB BOING:COLOR 1,0:LOCATE 25,4:PRINT "{GRN}*{YEL} MUST ENTER WORD {GRN}*";:GOTO PENTERWORD
GOTAWORD:
     S$=I$:GOSUB TRIM:GOSUB UCASE:HW$=S$:LOCATE 6,4:COLOR 4,0:PRINT "{PUR}HANG WORD IS: ";:PRINT "{YEL}";RPT$(DCHAR%(9),LEN(HW$));:LOCATE 10,5
     PRINT "{PUR}ENTER CLUE FOR WORD. {GRN}({WHT}OPTIONAL{GRN})";:ML=34:Y=14:X=4:IT=4:COLOR 7,4:GOSUB STRINGGET:HC$=I$:RETURN

PLAYERNAMES:
 GOSUB CLSGRAPH:COMPLETE.DRAW=TRUE:S$="Player Names":GOSUB GMENUBACK:Y=8:X=8:IT=4:ML=19:LOCATE 6,5:COLOR 4,0:PRINT "{PUR}PLAYER 1 NAME";:LOCATE 8,4:PRINT "{WHT}==";:PRINT "{RED}> ";
 GOSUB SHOWALL:COLOR 7,4:GOSUB STRINGGET:IF I$="" THEN I$="PLAYER 1"
 PL$(1)=I$:PL%(1,1)=0:COLOR 4,0:LOCATE 14,6:PRINT "{PUR}PLAYER 1 IS: ";:PRINT "{YEL}";PL$(1);:IF CH=1 THEN NAMESDONE
 LOCATE 6,5:PRINT "{PUR}PLAYER 2 NAME";:LOCATE 8,4:PRINT "{WHT}==";:PRINT "{RED}> ";:COLOR 7,4:GOSUB STRINGGET:IF I$="" THEN I$="PLAYER 2"
 COLOR 4,0:PL$(2)=I$:PL%(2,1)=0:LOCATE 16,6:PRINT "{PUR}PLAYER 2 IS: ";:PRINT "{YEL}";PL$(2);
NAMESDONE:
 SLEEP 90:RETURN

WORDFROMFILE:
  S$="{YEL} Getting{WHT} Next Word ":GOSUB PLAINMSG:IF FC%=1 THEN F=1:GOTO SKIPRF
  F=INT(RND(1)*FC%)+1:IF FC%>1 AND (F=SF%) THEN WORDFROMFILE
  SF%=F
SKIPRF:
  I$=RIGHT$(STR$(F),LEN(STR$(F))-1):WF$="HWORDS"+I$+".DAT":F$="WORDS/"+WF$+",S,R":OPEN 4,8,4,F$:INPUT#4,NL$:X=VAL(NL$):IF X<>0 THEN GETAWORD
  CLOSE 4:S$="{YEL} INVALID WORD FILE:{WHT} "+"WORDS/HWORDS"+WF$:GOTO ERRORHALT
GETAWORD:
  TL=INT(RND(1)*X)+1:IF TL=1 THEN SKIP7
  TL=(TL-1)*2:POKE A.REG,4:POKE Y.REG,INT(TL/256):POKE X.REG, TL-PEEK(782)*256:SYS $650:IF ST<>0 THEN CLOSE 4:GOTO WORDFROMFILE
SKIP7:
 INPUT#4,S$:GOSUB UCASE:HW$=S$:LINPUT#4,S$:IF NOT ISO.ON THEN GOSUB UCASE
 HC$=S$:CLOSE 4:RETURN

GMENUBACK:
  RECT 0,0,XLIMIT,YLIMIT,0:GOSUB FRAMESCRN:RECT 10,15,307,214,6:FRAME 13,27,304,211,12:RECT 15,29,302,209,12:CHAR 18,25,1,CHR$($0C)+S$:RETURN

FRAMESCRN:
  X1=5:Y1=9:X2=312:Y2=219:CC=$1C:FOR J=1 TO 6:FRAME X1,Y1,X2,Y2,CC:X1=X1+1:X2=X2-1:Y1=Y1+1:Y2=Y2-1:CC=CC-2:NEXT J:RETURN

PARTSCOUNT:
  COLOR 4,6:X=15:Y=9:H=3:W=20:GOSUB TEXTBOX:LOCATE 10,16:S$="{WHT}Body Parts Left:{YEL}"+STR$(BP):GOTO PETCHK

PUSHBTN:
 C1=$17:C2=1:C3=$61:C4=$10:GOSUB DRAWBTN:GOSUB CLICK:SLEEP 5:C1=1:C2=$17:C3=$C2:C4=$1E:GOTO DRAWBTN

DISABLEBTN:
 X=AL%(3,A):Y=AL%(4,A):W=14:H=14:C1=$14:C2=$12:C3=$11:C4=$10:L$=CHR$(LL):AL%(1,A)=1:GOTO DRAWBTN

LETTERPANL:
  S$="Letter Panel":GOSUB DRAWMSG:L=65:X=131:Y=100:W=14:H=14:C1=1:C2=$17:C3=$C2:C4=$1E:FRAME 123,93,261,174,$10:RECT 124,94,260,173,$C0:RECT 126,97,258,171,6:SX=X
  FOR CY=1 TO 3:FOR J=1 TO 7:L$=CHR$(L):GOSUB DRAWBTN:I=L-64:AL%(1,I)=0:AL%(2,I)=L:AL%(3,I)=X:AL%(4,I)=Y:X=X+W+4:L=L+1:NEXT J:Y=Y+W+4:X=SX:NEXT CY
  X=SX:FOR CY=1 TO 5:L$=CHR$(L):GOSUB DRAWBTN:I=L-64:AL%(1,I)=0:AL%(2,I)=L:AL%(3,I)=X:AL%(4,I)=Y:X=X+W+4:L=L+1:NEXT CY:RETURN

DRAWBTN:
   IF H=0 THEN H=W:I=-1
   X1=X+1:XW=X+W:YW=Y+H:Y1=Y+1:Y5=YW-1:X5=XW-1:LINE X,Y,XW,Y,C1:LINE X1,Y1,X5,Y1,C1:LINE XW,Y,XW,YW,C1:LINE X5,Y1,X5,Y5,C1
   LINE X,Y,X,YW,C2:LINE X1,Y1,X1,Y5,C2:LINE X,YW,X,YW,C2:LINE X,YW,X5,YW,C2:LINE X,Y5,XW-2,Y5,C2:RECT X+2,Y+2,XW-2,YW-2,C3:AX=4
## POSITION BUMPS TO CENTER THESE LETTERS ON THE BTN
   IF L$="M" THEN AX=3
   IF L$="W" THEN AX=2
   IF L$="F" OR L$="L" THEN AX=5
   IF L$="I" THEN AX=6
## DRAW THE LETTER ON THE BTN
## DRAW A SERIF ON I AND J FOR APPEARANCE SAKE
     CHAR X+AX,YW-3,C4,L$:IF L$="I" THEN LINE X+6,YW-9,X+8,YW-9,C4:LINE X+6,YW-3,X+8,YW-3,C4
     IF L$="J" THEN LINE X+7,YW-9,X+9,YW-9,C4
     IF H=W AND I THEN H=0
    RETURN

RESETCIRCLE:
  XSQUISH=1:YSQUISH=1:Q1=1:Q2=1:Q3=1:Q4=1:FILL=0:RETURN

  TEXTBOX:
     LOCATE Y,X:PRINT CHR$(DCHAR%(1));RPT$(DCHAR%(2),W-2);CHR$(DCHAR%(3));:IF H=2 THEN SKIPMID
     FOR RA=1 TO H-2:LOCATE Y+RA,X:PRINT CHR$(DCHAR%(4));RPT$(32,W-2);CHR$(DCHAR%(5));:NEXT RA
SKIPMID:
     LOCATE Y+H-1,X:PRINT CHR$(DCHAR%(6));RPT$(DCHAR%(7),W-2);CHR$(DCHAR%(8));:RETURN

SETUPTEXTMODE:
  GOSUB GETCHARMODE:IF NOT ISO.ON THEN PETSCIIMODE
ISOFONTS:
  PETSCII=FALSE:GOSUB LOADFONTS:F$=FONT1$:GOSUB FILEEXISTS:F=FE%:F$=FONT2$:GOSUB FILEEXISTS:F2=FE%
  IF NOT (F2 OR F) THEN PETSCIIMODE
  IF F AND (NOT F2) THEN FONT2$=FONT1$
  IF F2 AND (NOT F) THEN FONT1$=FONT2$
  FONTFILE$=FONT1$:GOTO LOADISOFONT

LOADFONTS:
  RESTORE DEFAULTFONTS:I$="FONT1":GOSUB GETINIVALUE:IF I$="" THEN READ FONT1$:GOTO TNEXTFONT
  FONT1$="FONTS/"+I$
TNEXTFONT:
  I$="FONT2":GOSUB GETINIVALUE:IF I$="" THEN READ FONT2$:RETURN
  FONT2$="FONTS/"+I$
FONTEND2:
  RETURN

DEFAULTFONTS:
  "THIN8X8.PF","VGAROM.PF"

PETSCIIMODE:
  PETSCII=TRUE:PRINT "{ISO OFF}{UPPER}{CHARSET SWITCH OFF}":GOSUB PETDRAW:ISO.ON=FALSE:GOTO THINFONT

SETISOMODE:
  PRINT "{ISO ON}":ISO.ON=TRUE:GOTO ISODRAW

LOADISOFONT:
  BVLOAD FONTFILE$,8,1,$F000

## COPY THE DIAMOND CHARACTER FROM ROM.
 OB=PEEK(1):BANK PEEK(0),6:CA=$C2D0:VA=$F748:FOR I=0 TO 7:X=PEEK(CA+I):VPOKE 1,VA+I,X:NEXT I:BANK PEEK(0),OB

FIXCURSOR:
  FBASE=$9F*8+$F000
  FOR X=0 TO 5:VPOKE 1,FBASE+X,0:NEXT X
  VPOKE 1,FBASE+6,$FF:VPOKE 1,FBASE+7,$FF

SETDRAWCHARS:
  IF ISO.ON THEN ISODRAW
  GOTO PETDRAW

ISODRAW:
  RESTORE ISODATA:GOTO READCHAR

PETDRAW:
  RESTORE PETDATA
READCHAR:
  FOR I=1 TO 9:READ DCHAR%(I):NEXT I:RETURN

PETDATA:
  DATA $6F,$A3,$70,$A5,$A7,$6C,$A4,$BA,$7A

ISODATA:
  DATA $C9,$CD,$BB,$BA,$BA,$C8,$CD,$BC,$E9

GETCHARMODE:
   ISO.ON=(PEEK($372) AND %01000000) <> 0:RETURN

LOSSSCREEN:
  IS.FADED=0:R%=15:G%=0:B%=0:P1=$0A:GOSUB RGBPAL:FOR I=0 TO 7:TC%(1,I)=$0A:TC%(2,I)=0:NEXT I:
  DC$=CHR$(255):GOSUB THICKFONT
  UC=1:WD$="L":X=22:Y=14:GOSUB BIGWORD:NEWZS=3:ZSM.RANDOM%(3)=TRUE:GOSUB SWAPSONGTO:GOSUB DEADFACE:S$=" Any Key to Continue ":GOSUB PLAINMSG:GOSUB FLUSHKEYS:RA=0:IS.FADED=0
  FOR CX = 0 TO 1 STEP 0
    GOSUB GETCHARX:IF MB>0 THEN X$="A"
    IF X$<>"" THEN CX=1:GOTO SKIPEYES
    RA=RA+1:IF RA/2=INT(RA/2) THEN GOSUB DIMPAL:IF RA>4000 THEN RA=0
    IF X$<>"" THEN CX=1:GOTO SKIPEYES
    FOR I= 1 TO 3:G%=0:R%=(RND(.)*12)+4:B%=INT(RND(.)*4):G%=0
      J=2:P1=$FE:GOSUB PALFADE:GOSUB GETCHARX:P1=$0A:IF R%<8 THEN R%=9
      J=2:GOSUB PALFADE:IF X$<>"" THEN I=4
      IF MB<>0 THEN I=4:X$="A"
    NEXT I
    IF MB>0 THEN X$="A"
    IF X$<>"" THEN CX=1
SKIPEYES:
  NEXT CX
ENDLOST:
  CLS:BVLOAD "HANGBG.DAT",8,0,0:GOTO THINFONT

DIMPAL:
  IF IS.FADED=15 THEN RETURN
  IS.FADED=IS.FADED+1:PAL.ADDR=$FA02:GOSUB SETUPVERA:POKE $02,$FE:SYS DEC.PAL.ENTRY:GOTO GETCHARX

SETUPVERA:
  P.HB=INT(PAL.ADDR/256):POKE VERA.CTRL,0:POKE VERA.LOWADDR, PAL.ADDR - (P.HB*256):POKE VERA.MIDADDR,P.HB:POKE VERA.HIGHADDR, %00010001:RETURN

DEADFACE:
  GOSUB MANAGEMUSIC:S$=PL$(CP%)+" Has Died":GOSUB PLAINMSG:P1=$24:P2=$FF:J=4:GOSUB PAL2PALFADE:P1=$3B:P2=$FE:J=4:GOSUB PAL2PALFADE
  P1=1:J=3:GOSUB PAL2PALFADE:P1=$3A:J=1:GOSUB PAL2PALFADE:P1=$15:J=3:GOSUB PAL2PALFADE:P1=$3B:J=4:GOSUB PAL2PALFADE:P1=$23:P2=$FF:J=6:GOSUB PAL2PALFADE:P1=$B8:J=5:GOSUB PAL2PALFADE
  P1=$B9:GOSUB PAL2PALFADE:P1=$BF:GOSUB PAL2PALFADE:P1=$C7:GOSUB PAL2PALFADE:GOTO MANAGEMUSIC

STRINGGET:
  GOSUB FLUSHKEYS:I$="":ID=0:GOSUB AREACLR
GETAKEY:
  GET X$:CC=ASC(X$):GOSUB ADJUSTPETLOWER:IF X$="" THEN GETAKEY
  C=ASC(X$):AC=0
  IF (IT<>2 OR IT=3) AND C>=65 AND C<=90 THEN AC=TRUE
  IF ISO.ON THEN IF (IT<>2 OR IT=3) AND C>=97 AND C<=122 THEN AC=TRUE
  IF (IT=2 OR IT=4 OR IT=3) AND C>=48 AND C<=57 THEN AC=TRUE
  IF (IT=2) AND C=46 AND ID=0 THEN AC=TRUE:ID=1
  IF (IT=4) AND C=32 THEN AC=TRUE: REM ALLOW SPACES WHEN INPUTTING A LINE
  IF (IT=4) AND (C>=35 AND C<=47) THEN AC=TRUE
  IF (IT=4) AND (C>=58 AND C<=63) THEN AC=TRUE  : REM ALLOW PUNCS IN STRING.
  IF C=13 THEN RETURN
  IF AC AND LEN(I$)<ML THEN PRINT CHR$(C);:I$=I$+CHR$(C):GOSUB CLICK:GOTO GETAKEY
  IF C<>20 THEN TOLONG
  IF LEN(I$)=0 THEN GOSUB BOING
  IF LEN(I$)=1 OR LEN(I$)=0 THEN I$="":GOSUB AREACLR:GOTO GETAKEY
  I=LEN(I$)-1:IF RIGHT$(I$,1)="." AND IT=2 THEN ID=0
  I$=LEFT$(I$,I):GOSUB AREACLR:PRINT I$;:GOSUB CLICK:GOTO GETAKEY
TOLONG:
  GOSUB BOING:GOTO GETAKEY

AREACLR:
  LOCATE Y,X:PRINT RPT$(32,ML);:LOCATE Y,X:RETURN

CLICK:
  IF UZSM% THEN ZCM.NUMBER=2:GOTO ZCMPLAY
  FMDRUM 7,26:RETURN

BOING:
  IF UZSM% THEN ZCM.NUMBER=1:GOTO ZCMPLAY
  FMDRUM 7,87:RETURN

FLUSHKEYS:
   GET X$:IF X$<>"" THEN FLUSHKEYS
   RETURN

BACKGROUND:
  F$="HANGBG.DAT":GOSUB FILEEXISTS:IF NOT FE% THEN SKIPLOAD
  IF COMPLETE.DRAW THEN GOSUB HIDEGRAPHICS
  BVLOAD F$,8,0,0:GOSUB SETDRAWPAL:IF COMPLETE.DRAW THEN GOSUB SHOWGRAPHICS
  IF NOT GOT.UNDER THEN GETUNDER
  RETURN
SKIPLOAD:
  J=3:XLIMIT=319:YLIMIT=239:XSQUISH=1:YSQUISH=1:P1=$C0:P2=$F2:GOSUB COPYPALET:R%=0:G%=0:B%=1:GOSUB RGBPAL:S$="The Sky":GOSUB DRAWMSG
  RECT 0,0, XLIMIT, YLIMIT,$C0:P1=$F2:P2=$C0:GOSUB PAL2PALFADE:P1=$C0:P2=$10:GOSUB COPYPALET:P1=7:P2=$F1:GOSUB COPYPALET:P1=$C0:P2=7
  GOSUB COPYPALET:CX=5:CY=4:CC=$10:FILL=1:XSQUISH=1:YSQUISH=1:Q1=1:Q2=1:Q3=1:Q4=1:RA=32:GOSUB BCIRCLE:CC=7:CX=5:CY=4:RA=30:FILL=1:RA=30:GOSUB BCIRCLE:FILL=0:C=7
  LINE 2,37,2,44,C:LINE 6,37,6,44,C:LINE 9,37,10,44,C:LINE 12,36,14,43,C:LINE 15,35,17,42,C:LINE 18,34,21,41,C:LINE 20,33,24,39,C:LINE 22,31,27,37,C
  LINE 24,28,29,35,C:LINE 27,25,32,32,C:LINE 30,23,35,29,C:LINE 32,21,37,26,C:LINE 33,19,39,23,C:LINE 35,17,41,20,C:LINE 36,15,43,17,C:LINE 37,12,44,14,C:LINE 38,10,45,11,C
  LINE 39,7,45,8,C:LINE 39,4,45,5,C:LINE 39,1,46,2,C:P1=0:P2=$10:J=3:GOSUB PAL2PALFADE:P1=$F1:P2=7:GOSUB PAL2PALFADE:FILL=1:GOSUB DRWCLOUDS:GOSUB DRWCLOUDS:GOSUB DRWCLOUDS
  S$="Grass":GOSUB DRAWMSG:P1=105:P2=$F2:GOSUB COPYPALET:P2=P1:P1=$C0:GOSUB COPYPALET:P1=$85:P2=$F3:GOSUB COPYPALET:P2=P1:P1=$C0:GOSUB COPYPALET:RECT 0,180,XLIMIT,YLIMIT,$85
  FOR Y=161 TO 179:LINE 0,Y,40,179,105:NEXT Y
  FOR Y=180 TO 150 STEP -1:LINE 288,179,XLIMIT,Y,105:NEXT Y
  J=5:P2=$85:P1=$F3:GOSUB PAL2PALFADE:P2=105:P1=$F2:GOSUB PAL2PALFADE:COLOR 1
     FOR I=1 TO 550
         X1=INT(RND(.)*310)+5
       NEWY:
         Y1=INT(RND(.)*60)+180:IF Y1>YLIMIT THEN NEWY
         GOSUB GRASSCLUMP:NEXT I
         F$="BACKGROUND SCREEN"
SAVESCREEN:
  S$="Saving: "+F$:GOSUB PLAINMSG
  IF F$="BACKGROUND SCREEN" THEN FF$="@:HANGBG.DAT,P,W":GOTO DOIT
  FF$="@:"+F$ + ",P,W"
DOIT:
  OPEN 2,8,2,FF$:POKE A.REG,2:POKE$9F25,0:POKE$9F20,0:POKE$9F21,0:POKE$9F22,$10:SYS$700:CLOSE 2
GETUNDER:
PUTIMAGE=FALSE:X1=290:Y1=166:X2=304:Y2=211:F$="UNDER.DAT":GOT.UNDER=-1:GOTO BITBLT

GRASSCLUMP:
  GOSUB GRASSCOLOR:LINE X1,Y1,X1-4,Y1-5,GC:GOSUB GRASSCOLOR:LINE X1,Y1,X1-3,Y1-3,GC:GOSUB GRASSCOLOR:LINE X1,Y1,X1,Y1-5,GC:GOSUB GRASSCOLOR
  LINE X1,Y1,X1+3,Y1-3,GC:GOSUB GRASSCOLOR:LINE X1,Y1,X1+4,Y1-5,GC
GRASSCOLOR:
  GC=INT(RND(.)*24)+$60:RETURN

DRWCLOUDS:
  S$="Clouds":GOSUB DRAWMSG:H=INT(RND(.)*(200))+45:HL=INT(RND(.)*30)+30:C1=INT(RND(.)*30)+6:C2=INT(RND(.)*11)+7:C2=C1+C2
  FOR Y=C1 TO C2 STEP 3:FOR CX=H TO H+HL STEP 4:RA=INT(RND(.)*5)+3:CC=INT(RND(.)*4)+$1C:CY=INT(RND(.)*4)+(Y-4):IF (CY-RA)<0 THEN GOSUB BCIRCLE:GOTO SKIPPERB
  GOSUB CCIRCLE
SKIPPERB:
  NEXT CX:NEXT Y:RETURN

CCIRCLE:
     C3=RA:G=0:C4=2*(1-RA):W=INT(2*320/240)
     FOR X = 0 TO 2 STEP 0:LINE CX-G,CY-C3,CX+G,CY-C3,CC:LINE CX-G,CY+C3,CX+G,CY+C3,CC
       IF (C4+RA)>0 THEN C3=C3-1:C4=C4-W*C3-1
       IF G>C4 THEN G=G+1: C4=C4+2*G+1
       IF C3<0 THEN X=2
     NEXT X:RETURN

DRAWGALLOWS:
     GOSUB CLRMSG:FRAME 189,195,285,208,$10:FRAME 188,194,285,211,$10:LINE  189,210,285,210,$10:PSET 189,209,$10:PSET 284,206,$10:PSET 284,209,$10:FRAME 275,21,285,207,$10
     FRAME 276,22,284,205,$10:FRAME 67,20,285,30,$10:FRAME 68,21,284,29,$10:RECT 71,30,79,33,$10:RECT 190,196,283,209,$53:RECT 277,23,283,209,$53:RECT 69,22,283,28,$53:RETURN

DRAWNOOSE:
  S$="The  NOOSE":GOSUB DRAWMSG:F$="NOOSE.DAT":GOSUB FILEEXISTS:IF FE% AND (NOT FORCEDRAW) THEN NOOSEFACEBLIT
  LINE 73,33,73,53,16:LINE 77,33,77,53,16:RECT 74,34,76,53,87:FOR Y=38 TO 53 STEP 3:LINE 73,Y,77,Y-3,BLACK2:NEXT Y:FRAME 71,53,80, 68,16:RECT 72,54,79,68,87
  FOR Y=56 TO 68 STEP 4:LINE 72,Y,79, Y-4,BLACK2:NEXT Y: FILL=0:XSQUISH=1:RA=24:CX=75:CY=79:CC=BLACK2:YSQUISH=.38:Q1=1:Q2=1:Q3=1:Q4=1:YSQUISH=.38:GOSUB BCIRCLE:RA=25:GOSUB BCIRCLE
  RA=24:GOSUB BCIRCLE:RA=23:GOSUB BCIRCLE:RA=19:GOSUB BCIRCLE:RA=18:GOSUB BCIRCLE:CC=87:FOR RA=20 TO 23 STEP .6:GOSUB BCIRCLE:NEXT RA:PUTIMAGE=FALSE:GOTO NOOSEFACEBLIT

DRAWFACE:
  S$="A Troubled Face":GOSUB DRAWMSG:F$="FACE.DAT":GOSUB FILEEXISTS:IF FE% AND (NOT FORCEDRAW) THEN NOOSEFACEBLIT
  CX=58:CY=60:RA=6:XSQUISH=.4:YSQUISH=1:CC=BLACK2:Q1=1:Q2=0:Q3=1:Q4=0:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:FILL=1:CC=FLESHCOLOR:GOSUB BCIRCLE
  FILL=0:CX=90:RA=6:CC=BLACK2:Q1=0:Q2=1:Q3=0:Q4=1:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:FILL=1:CC=FLESHCOLOR:GOSUB BCIRCLE:LINE 93,58,93,62,BLACK2
  Q1=1:Q2=Q1:Q3=Q1:Q4=Q1:LINE 67,76,67,84,BLACK2:LINE 66,76,66,84,BLACK2:LINE 67,87,67,90,BLACK2:LINE 66,87,66,90,BLACK2:LINE 82,76,82,84,BLACK2:LINE 83,76,83,84,BLACK2
  LINE 82,87,82,90,BLACK2:LINE 83,87,83,90,BLACK2:RECT 68,76,81,84,FLESHCOLOR:RECT 68,89,81,90,FLESHCOLOR:RA=20:XSQUISH=.8:FILL=1:CC=BLACK2:CX=74:CY=63
  GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:RA=RA-2:CY=CY+1:CC=$FF:FILL=1:GOSUB BCIRCLE:XSQUISH=1:YSQUISH=XSQUISH:CY=CY-6:CX=CX-6:RA=3:CC=$FE:GOSUB CCIRCLE:PSET CX+4,CY,$FF
  GOSUB PUPILS:CX=CX+12:GOSUB CCIRCLE:PSET CX+4,CY,$FF:GOSUB PUPILS:CX=74:CY=63:LINE CX-1,CY,CX-2,CY+6,BLACK2:LINE CX+1,CY,CX+2,CY+6,BLACK2:LINE CX,CY,CX-1,CY+6,$23
  LINE CX,CY,CX+1,CY+6,$23:LINE CX,CY+3,CX,CY+6,$22:Q3=0:Q4=0:CC=BLACK2:CY=CY+13:YSQUISH=.35:RA=6:FILL=0:GOSUB BCIRCLE:CY=CY+1:CC=$31:GOSUB BCIRCLE:CY=CY+1:CC=BLACK2
  GOSUB BCIRCLE:Q3=1:Q4=1:YSQUISH=1:PUTIMAGE=FALSE:GOTO NOOSEFACEBLIT
PUPILS:
  PSET CX,CY,BLACK2:PSET CX-1,CY,BLACK2:PSET CX,CY+1,BLACK2:PSET CX-1,CY+1,BLACK2:RETURN

NOOSEFACEBLIT:
  BLITWIDTH=57:BLITLINES=75:X1=46:Y1=33:X2=102:Y2=107:GOTO CHOOSEBLIT

DRWTORSO:
  S$="Torso":GOSUB DRAWMSG:LINE 82,90,105,93,BLACK2:LINE 83,91,105,94,BLACK2:LINE 68,90,42,93,BLACK2:LINE 69,91,42,94,BLACK2:LINE 67,90,74,105,BLACK2:LINE 83,90,74,105,BLACK2
  FOR X=81 TO 68 STEP -1:LINE 75,103,X,90,FLESHCOLOR:NEXT X
  LINE 74,105,72,110,BLACK2:LINE 72,110,72,141,BLACK2:LINE 72,141,53,144,BLACK2:LINE 53,144,53,108,BLACK2:RECT 71,140,54,103,SHIRTCOLOR:LINE 54,141,68,141,SHIRTCOLOR:LINE 54,142,62,142,SHIRTCOLOR
  LINE 54,143,56,143,SHIRTCOLOR:PSET 65,91,BLACK2:LINE 72,102,72,108,SHIRTCOLOR:LINE 73,104,73,106,8:PSET 74,109,8:RECT 47,107,68,94,8:RECT 69,96,69,99,8:RECT 42,107,48,95,SHIRTCOLOR
  LINE 56,93,67,93,SHIRTCOLOR:PSET 55,92,BLACK2:PSET 64,91,BLACK2:LINE 65,92,67,92,SHIRTCOLOR:RECT 68,100,71,102,SHIRTCOLOR:LINE 70,98,70,100,SHIRTCOLOR:RECT 73,110,91,140,SHIRTCOLOR
  RECT 75,105,91,109,SHIRTCOLOR:RECT 88,94,101,106,SHIRTCOLOR:RECT 81,95,105,106,SHIRTCOLOR:LINE 80,96,80,105,SHIRTCOLOR:LINE 79,98,79,105,SHIRTCOLOR:LINE 78,100,78,105,SHIRTCOLOR
  LINE 77,101,77,105,SHIRTCOLOR:  LINE 76,103,76,105,SHIRTCOLOR:LINE 74,103,75,103,BLACK2:PSET 76,101,BLACK2:PSET 73,101,BLACK2:PSET 72,99,BLACK2:PSET 71,97,BLACK2:PSET 70,95,BLACK2
  PSET 69,93,BLACK2:PSET 81,92,BLACK2:PSET 80,94,BLACK2:PSET 80,96,BLACK2:PSET 78,97,BLACK2:PSET 77,99,BLACK2:LINE 76,100,76,103,BLACK2:RECT 82,94,93,93, SHIRTCOLOR:LINE 83,92,86,92,8
  LINE 74,107,74,108,8:PSET 73,109,BLACK2:PSET 73,141,BLACK2:LINE 76,141,91,141,SHIRTCOLOR:LINE 81,142,91,142,SHIRTCOLOR:LINE 89,143,91,143,SHIRTCOLOR:LINE 74,141,92,144,BLACK2
  LINE 92,144,92,107,BLACK2:PSET 73,141,BLACK2:GOSUB RESETCIRCLE:CC=16:RA=1.2:CX=75:FILL=1:FOR CY=113 TO 143 STEP 8:GOSUB BCIRCLE:NEXT CY:LINE 58,108,68,108,BLACK2:LINE 58,108,58,116,BLACK2
  LINE 68,108,68,116,BLACK2:Q1=0:Q2=0:Q3=1:Q4=1:RA=4.5:XSQUISH=1:YSQUISH=.6:CX=63:CY=116:CC=BLACK2:FILL=0:GOSUB BCIRCLE:X$="P-"+RIGHT$(STR$(CP%),LEN(STR$(CP%))-1):CHAR 57,106,BLACK2,X$:RETURN

DRWLEFTARM:
  S$="Left Arm":GOSUB DRAWMSG:F$="LEFTARM.DAT":GOSUB FILEEXISTS
  IF FE% AND (NOT FORCEDRAW) THEN X1=91:Y1=92:BLITWIDTH=22:BLITLINES=57:GOTO CHOOSEBLIT
  Q1=0:Q2=1:Q3=0:Q4=0:FILL=0:XSQUISH=.52:RA=16:CC=BLACK2:CY=116:CX=92
  GOSUB BCIRCLE:RA=RA+.6:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE:XSQUISH=.28:CX=106:CY = 105:FILL=0:GOSUB BCIRCLE:FOR L=1 TO 3:RA=RA+.5:GOSUB BCIRCLE:NEXT L
  CC=8:Q1=0:Q2=1:Q3=0:Q4=0:FILL=1:RA=RA-2.5:GOSUB BCIRCLE:RECT CX-1,CY-3,CX+2,CY-7,8:LINE 99,113,99,133,BLACK2:LINE 111,102,111,133,BLACK2:RECT 100,102,110,133,8:LINE 99,107,99,109,8
  LINE 98,108,101,108,8:LINE 97,107,100,107,8 :PSET 94,107,$C0:LINE 99,134,111,134,BLACK2:LINE 101,134,101,143,BLACK2:LINE 101,143,103,143,BLACK2:LINE 102,142,102,139,FLESHCOLOR
  LINE 103,144,103,140,BLACK2:LINE 103,145,105,145,BLACK2:LINE 104,144,104,139,FLESHCOLOR:LINE 105,146,105,140,BLACK2:LINE 105,146,107,146,BLACK2:LINE 106,145,106,139,FLESHCOLOR
  LINE 107,146,107,140,BLACK2:LINE 107,145,109,145,BLACK2:LINE 108,144,108,139,FLESHCOLOR:LINE 109,145,109,134,BLACK2:RECT 102,139,108,135,$25:PUTIMAGE=FALSE:X1=91:Y1=92:X2=112:Y2=148:GOTO BITBLT

DRWRIGHTARM:
  S$="Right Arm":GOSUB DRAWMSG:F$="RIGHTARM.DAT":GOSUB FILEEXISTS:IF FE% AND (NOT FORCEDRAW) THEN X1=33:Y1=92:BLITWIDTH=22:BLITLINES=57:GOTO CHOOSEBLIT
  Q1=1:Q2=0:Q3=0:Q4=0:FILL=0:XSQUISH=.52:RA=16:CC=BLACK2:CY=118:CX=54:GOSUB BCIRCLE:RA=RA+.6:GOSUB BCIRCLE:RA=RA-1:GOSUB BCIRCLE
  LINE 54,107,54,109,8:XSQUISH=.43:CX = 42:CY = 105:FILL=0:GOSUB BCIRCLE:FOR L=1 TO 3:RA=RA+.3:GOSUB BCIRCLE:NEXT L
  CC=8:Q1=1:Q2=0:Q3=0:Q4=0:FILL=1:RA=RA-3:GOSUB BCIRCLE:FILL=0:RECT CX-4,CY-8,CX+3,CY+6,8:RECT CX-4,CY-4,CX,CY+6,8:LINE 34,102,34,133,BLACK2:LINE 46,115,46,133,BLACK2
  RECT 35,102,45,133,8:LINE 34,134,46,134,BLACK2:LINE 46,CY,46,CY+6,8:LINE 47,CY,47,CY+5,8:RECT 47,CY,49,CY+3,8:LINE 51,CY+4,52,CY+4,$C0:PSET 48,CY+4, 8:LINE 44,134,44,143,BLACK2
  LINE 44,143,42,143,BLACK2:LINE 43,142,43,139,FLESHCOLOR:LINE 42,140,42,145,BLACK2:LINE 42,145,40,145,BLACK2:LINE 41,144,41,139,FLESHCOLOR:LINE 40,146,40,140,BLACK2:LINE 40,146,38,146,BLACK2
  LINE 39,145,39,139,FLESHCOLOR:LINE 38,146,38,140,BLACK2:LINE 38,145,36,145,BLACK2:LINE 37,144,37,139,FLESHCOLOR:LINE 36,145,36,134,BLACK2:RECT 43,139,37,135,FLESHCOLOR:PUTIMAGE=FALSE:X1=33
  Y1=92:X2=54:Y2=148:GOTO BITBLT

DRWRIGHTLEG:
  S$="Right Leg":GOSUB DRAWMSG:F$="RIGHTLEG.DAT":GOSUB FILEEXISTS:IF FE% AND (NOT FORCEDRAW) THEN X1=52:Y1=142:BLITWIDTH=24:BLITLINES=79:GOTO CHOOSEBLIT
  Q1=1:Q2=0:Q3=0:Q4=0:FILL=0:CC=BLACK2:CX=74:CY=159:RA=8:XSQUISH=.43:YSQUISH=.6:GOSUB BCIRCLE:LINE 70,159,70,192,BLACK2:LINE 55,145,53,192,BLACK2:LINE 53,193,70,193,BLACK2
  RECT 56,145,69,192,LEGCOLOR:LINE 55,157,55,192,LEGCOLOR:LINE 54,181,54,192,LEGCOLOR:LINE 57,144,71,144,LEGCOLOR:RECT 69,142,71,154,LEGCOLOR:RECT 72,142,73,153,LEGCOLOR
  LINE 63,143,68,143,LEGCOLOR:PSET 70,155,LEGCOLOR:Q1=1:Q2=1:Q3=1:Q4=1:RA=20:XSQUISH=.35:CC=BLACK2:FILL=1:CX=62:CY=208:GOSUB BCIRCLE:RA=RA+1:FILL=0:CC=$12:GOSUB BCIRCLE:FILL=1
  XSQUISH=.38:CY=204:CC=$1C:RA=11:GOSUB BCIRCLE:RA=RA+1:CC=$12:FILL=0:GOSUB BCIRCLE:LINE 57,193,57,202,BLACK2:LINE 66,193,66,202,BLACK2:RECT 58,194,65,200,$1C
  PUTIMAGE=FALSE:X1=52:Y1=142:X2=75:Y2=220:GOTO BITBLT

DRWLEFTLEG:
  S$="Left Leg":GOSUB DRAWMSG:F$="LEFTLEG.DAT":GOSUB FILEEXISTS:IF FE% AND (NOT FORCEDRAW) THEN X1=73:Y1=142:BLITWIDTH=21:BLITLINES=79:GOTO CHOOSEBLIT
  Q1=0:Q2=1:Q3=0:Q4=0:FILL=0:CC=BLACK2:CX=74:CY=159:RA=8:XSQUISH=.43:YSQUISH=.6:GOSUB BCIRCLE:LINE 77,157,77,192,BLACK2:LINE 90,145,92,192,BLACK2:LINE 77,193,92,193,BLACK2
  RECT 78,145,89,192,LEGCOLOR:LINE 90,157,90,192,LEGCOLOR:LINE 91,181,91,192,LEGCOLOR:LINE 76,144,88,144,LEGCOLOR:RECT 76,143,79,154,LEGCOLOR:RECT 74,142,76,153,LEGCOLOR
  LINE 75,143,82,143,LEGCOLOR:LINE 77,154,77,156,LEGCOLOR:Q1=1:Q2=1:Q3=1:Q4=1:RA=20:XSQUISH=.35:CC=BLACK2:FILL=1:CX=85:CY=208:GOSUB BCIRCLE:RA=RA+1:FILL=0:CC=$12:GOSUB BCIRCLE
  FILL=1:XSQUISH=.38:CY=204:CC=$1C:RA=11:GOSUB BCIRCLE:RA = RA+1:CC=$12:FILL=0:GOSUB BCIRCLE:LINE 80,193,80,202,BLACK2:LINE 89,193,89,202,BLACK2
  RECT 81,194,88,200,$1C:PUTIMAGE=FALSE:X1=73:Y1=142:X2=93:Y2=220:GOTO BITBLT

SUNSMILE:
  COUNT=0
STARTSMILE:
  F$="SMILE.DAT":GOSUB FILEEXISTS:IF FE% THEN BLITWIDTH=34:BLITLINES=34:X1=0:Y1=0:GOSUB GRAPHBLITIMAGE:GOTO BLINK
  Q1=1:Q2=1:Q3=1:Q4=1:YSQUISH=1:XSQUISH=1:RA=4:CX=17:CY=6:CC=1:FILL=1:GOSUB BCIRCLE:RA=1:CC=BLACK2:GOSUB BCIRCLE:RA=5:FILL=0:GOSUB BCIRCLE:CX=1:CY=15:YSQUISH=.4:Q1=0:Q2=0:RA=20
  GOSUB BCIRCLE:CY=16:GOSUB BCIRCLE:CY=17:GOSUB BCIRCLE:Q1=1:Q2=1:PUTIMAGE=FALSE:X1=0:Y1=0:X2=33:Y2=33:GOSUB BITBLT
BLINK:
  IF COUNT>0 THEN RETURN
  COUNT=COUNT+1:Q1=1:Q2=1:Q3=1:Q4=1:YSQUISH=1:XSQUISH=1:RA=4:CX=17:CY=6:CC=$53:FILL=1:GOSUB BCIRCLE:SLEEP 5:GOTO STARTSMILE

BCIRCLE:
  C1=RA:X=0:D=2*(1-RA):W=INT(2*320/240)
##     IF XSQUISH<0 OR XSQUISH>1 THEN XSQUISH=1
##     IF YSQUISH<0 OR YSQUISH>1 THEN YSQUISH=1
FOR J=0 TO 3 STEP 0:DX=X*XSQUISH:DY=C1*YSQUISH:ZX=CX-DX:ZY=CY-DY:AX=CX+DX:AY=CY+DY:IF FILL=1 THEN DOFILL
  IF ZX<0 OR ZX>XLIMIT OR ZY<0 OR ZY>YLIMIT OR Q1=0 THEN SKIP4
  PSET ZX,ZY,CC
SKIP4:
  IF AX<0 OR AX>XLIMIT OR ZY<0 OR ZY>YLIMIT OR Q2=0 THEN SKIP2
  PSET AX,ZY,CC
SKIP2:
  IF ZX<0 OR ZX>XLIMIT OR AY<0 OR AY>YLIMIT OR Q3=0 THEN SKIP3
  PSET ZX,AY,CC
SKIP3:
  IF AX<0 OR AX>XLIMIT OR AY<0 OR AY>YLIMIT OR Q4=0 THEN SKIPFILL
  PSET AX,AY,CC:GOTO SKIPFILL
DOFILL:
  X1=ZX:X2=AX:IF (Q1=0 AND Q2=O) OR X1>XLIMIT THEN FILL2
  IF ZY<0 OR ZY>YLIMIT THEN FILL2
  IF X1<0 THEN X1=0
  IF X2>XLIMIT THEN X2=XLIMIT
  IF Q1=0 THEN X1=CX
  IF Q2=0 THEN X2=CX
  LINE X1,ZY,X2,ZY,CC
FILL2:
  IF (Q3=0 AND Q4=0) OR ZX>XLIMIT THEN SKIPFILL
  IF AY<0 OR AY>YLIMIT THEN SKIPFILL
  IF ZX<0 THEN ZX=0
  IF AX>XLIMIT THEN AX=XLIMIT
  IF Q3=0 THEN ZX=CX
  IF Q4=0 THEN AX=CX
  LINE ZX,AY,AX,AY,CC
SKIPFILL:
  IF (D+RA)>0 THEN C1=C1-1:D=D-W*C1-1
  IF X>D THEN X=X+1:D=D+2*X+1
  IF C1<0 THEN J=3
NEXT J
BCLOOPEND:
  RETURN

MANAGEMUSIC:
  IF (NOT UZSM%) OR (ZTIMER>TI) THEN RETURN
  ZTIMER=0:IF MUSIC.PAUSED%(ZS) THEN RETURN
  GOSUB ZSMGETSTATE:IF ZSM.IS.PLAYING THEN RETURN
  IF USING.LST%(ZS) THEN GOSUB GETZSMFROMLIST:GOSUB ZSMCLOSE:GOSUB DOLOADZSM:GOTO STARTMUSIC
  GOSUB ZSMREWIND:GOTO STARTMUSIC

SWAPSONGTO:
  GOSUB PUSHSONG:ZS=NEWZS:GOSUB LOADZSM:GOTO STARTMUSIC

PLAYFANFARE:
  F$="FANFARE.DAT":GOSUB FILEEXISTS:IF NOT FE% THEN GOTO NFMSG
  OPEN 10,8,10,"FANFARE.DAT,S,R":INPUT# 10, X$
  I=VAL(X$):X=INT(RND(1)*I)+1:IF X=1 THEN SKIPFF
  X=X-1:POKE A.REG,10:POKE Y.REG,INT(X/256):POKE X.REG, X-PEEK(Y.REG)*256:SYS $650
SKIPFF:
  INPUT# 10,F$,ZTIMER:CLOSE 10:GOSUB FILEEXISTS:IF NOT FE% THEN GOTO NFMSG
  ZTIMER=INT(ZTIMER*60)+30:GOSUB PUSHSONG:ZS=0:ZNUM%(0)=-1
  BLOAD F$,8,2,$A000:ZCM.NUMBER=10:ZCM.BANK=2:GOSUB ZCMSETMEM:GOSUB ZCMPLAY:ZTIMER=ZTIMER+TI:RETURN
NFMSG:
  S$=F$+" Not Found":GOTO PLAINMSG

ZCMSETMEM:
  POKE A.REG, 0:POKE Y.REG, $A0
ZCMSETMEM2:
  BANK ZCM.BANK:POKE X.REG, ZCM.NUMBER:SYS $8C4B:RETURN

PUSHSONG:
  WAS.PAUSED=MUSIC.PAUSED%(ZS):GOSUB PAUSEMUSIC:OLDZS=ZS:ZSAVENAME$=ZSMNAME$:IF USING.LST%(ZS) THEN SAVEZ=CURRENTZSM
  RETURN

SWAPSONGBACK:
  GOSUB PAUSEMUSIC:GOSUB ZSMCLOSE:GOSUB POPSONG:ZTIMER=TI+90:RETURN

POPSONG:
  CK=ZS:ZS=OLDZS:ZSMNAME$=ZSAVENAME$:IF USING.LST%(ZS) THEN CURRENTZSM=SAVEZ
  MUSIC.PAUSED%(ZS)=WAS.PAUSED:IF ZNUM%(CK)=ZNUM%(ZS) THEN GOSUB DOLOADZSM:GOTO POPSKIP
  BLOAD ZSMNAME$,8,2,$A000
POPSKIP:
  IF NOT MUSIC.PAUSED%(ZS) THEN SLEEP 5:GOSUB STARTMUSIC
  RETURN

PLAYSONG:
  IF NOT UZSM% THEN RETURN
  IF ZS=LASTZS THEN GOTO MANAGEMUSIC
  X=ZS:ZS=LASTZS:GOSUB PAUSEMUSIC:GOSUB ZSMCLOSE:ZS=X:MUSIC.FILENAME$=MUSIC.NAME$(ZS):F$=MUSIC.FILENAME$:GOSUB FILEEXISTS:IF NOT FE% THEN RETURN
  IF ZS<>LASTZS THEN GOSUB LOADZSM
  GOSUB STARTMUSIC:LASTZS=ZS:RETURN

STARTMUSIC:
   MUSIC.PAUSED%(ZS)=0:ZSM.ON%=TRUE:POKE X.REG, ZNUM%(ZS):SYS $8C06
   IF USING.LST%(ZS) THEN LOOP.ON=0:GOSUB SETZSMLOOP
   GOTO SETITNOW

SETZSMLOOP:
  IF LOOP.ON THEN LOOP.ON=1
  POKE X.REG, ZNUM%(ZS):POKE C.REG,LOOP.ON:SYS $8C33:RETURN

PAUSEMUSIC:
  MUSIC.PAUSED%(ZS)=-1:POKE X.REG,ZNUM%(ZS):SYS $8C09:RETURN

LOADZSM:
  USING.LST%(ZS)=0:MUSIC.FILENAME$=MUSIC.NAME$(ZS)
  IF RIGHT$(MUSIC.FILENAME$,4)=".LST" THEN GOSUB GETZSMFROMLIST:USING.LST%(ZS)=-1:GOTO DOLOADZSM
  ZSMNAME$=MUSIC.FILENAME$
DOLOADZSM:
  BLOAD ZSMNAME$,8,2,$A000
## NOW TELL ZSMKIT WHERE THE SONG LIVES
ZSMSETMEM:
  BANK 2:POKE A.REG,ZNUM%(ZS):POKE X.REG,0:POKE Y.REG,$A0:SYS $8C1E:RETURN

ZSMCLOSE:
  POKE X.REG, ZNUM%(ZS):SYS $8C0F:ZSM.ON%=0:RETURN

GETZSMFROMLIST:
  F$=MUSIC.NAME$(ZS):GOSUB FILEEXISTS:IF NOT FE% THEN RETURN
  MUSIC.FILENAME$=MUSIC.NAME$(ZS)
RETRYLST:
  IF CURRENTZSM<=0 THEN CURRENTZSM=1
  OPEN 10,8,10,MUSIC.FILENAME$ + ",S,R":INPUT# 10,ZCNT$:ZSM.COUNT=VAL(ZCNT$)
  ENDZSM=CURRENTZSM:IF ENDZSM>ZSM.COUNT THEN ENDZSM=ZSM.COUNT

RANDOMZSM:
  IF ZSM.RANDOM%(ZS) THEN ENDZSM=INT(RND(1)*ZSM.COUNT)+1:IF LAST.SAVEDZSM=ENDZSM THEN RANDOMZSM
  LAST.SAVEDZSM=ENDZSM

## DEBUG OUTPUT  S$ = "ZS: "+STR$(ZS)+" "+MUSIC.FILENAME$+" ENDZSM"+STR$(ENDZSM):GOSUB PLAINMSG:SLEEP 450

  IF ENDZSM=1 THEN SKIPZSMLOOP
  FOR I = 1 TO ENDZSM
    INPUT# 10, X$:X=ST
    IF X<>0 THEN I=ENDZSM
  NEXT I
## DEBUG OUTPUT S$="LIST LOOP DONE":GOSUB PLAINMSG
  IF X<>0 THEN CLOSE 10:CURRENTZSM=0:GOTO RETRYLST
  GOTO SETZSMPOS
SKIPZSMLOOP:
  INPUT# 10, X$
SETZSMPOS:
  CURRENTZSM=CURRENTZSM+1:IF CURRENTZSM > ZSM.COUNT+1 THEN ZSM.RANDOM%(ZS)=TRUE
  ZSMNAME$=MUSIC.DIR$+X$:CLOSE 10:RETURN

ZSMGETSTATE:
  POKE X.REG,ZNUM%(ZS):SYS $8C2A:ZSM.IS.PLAYING=PEEK(C.REG) AND 1:ZSM.LOOPS=PEEK(PEEK(Y.REG))+PEEK(PEEK(X.REG))*256:RETURN

ZSMREWIND:
  POKE X.REG,ZNUM%(ZS):SYS $8C0C:RETURN

ZCMPLAY:
  POKE X.REG, ZCM.NUMBER:POKE A.REG,ZCVOLUME:SYS $8C4E:RETURN

BIGWINANIM:
  COMPLETE.DRAW=TRUE:MOUSE 0:GOSUB THICKFONT:GOSUB BLOCKSMILE:X1=35:X2=112:Y1=45:Y2=215:CC=0
FRAMEIT:
  CC=0:IF X1/2=INT(X1/2) THEN CC=11
  FRAME X1,Y1,X2,Y2,CC:IF X1<75 THEN X1=X1+1
  IF X2>75 THEN X2=X2-1
  IF Y1<105 THEN Y1=Y1+1
  IF Y2>105 THEN Y2=Y2-1
  SLEEP:IF X1<>75 OR X2<>75 THEN FRAMEIT
  COLOR 1,0:CLS:GOSUB FORCEDEFPAL:X1=42:Y1=50:BLITWIDTH=64:BLITLINES=100:GOSUB SPLITSET:SLEEP 60
  P1=$C1:P2=0:GOSUB COPYPALET:RECT 0,0,XLIMIT,45,0:RECT 0,216,XLIMIT,YLIMIT,0:RECT 0,45,35,215,0:RECT 112,45,XLIMIT,215,0:CLS:P1=$84:P2=5:GOSUB COPYPALET


  RECT 0,0,XLIMIT,YLIMIT,0:COLOR 0,5:LOCATE 30,1:PRINT RPT$(32,40)
  FOR X1=45 TO 272 STEP 2:IF Y1< 118 THEN Y1=Y1+1
  GOSUB BLITIMAGE:NEXT X1

  X1=42:Y1=48:P1=7:R%=13:G%=0:B%=3:GOSUB RGBPAL
  UC=0:DC$=CHR$(255):COLOR 7,0:X=1:Y=2:WD$=S$:GOSUB BIGWORD:X=1:Y=11:WD$=I$:GOSUB BIGWORD

  GET X$:IF X$="{ESC}" THEN ENDANIM
  I=1:GOSUB FIREWORKS

  LOCATE 20,8:COLOR 1:PRINT "LETS GET OUT OF HERE";
  LOCATE 22,8:PRINT "EXIT...{LIGHT RED}STAGE {RED}LEFT{YEL} !!";

  IF NOT LAYERS.SWAPPED THEN GOSUB SWAPVERALAYERS
X1=272:Y1=118
GETIN=$FFE4:ZTIMER=TI+620
FOR J=1 TO 2 STEP 0
    FOR I = 1 TO 16:F$="CELS/CELR"+MID$(STR$(I),2)+".BIN":GOSUB GRAPHBLITIMAGE:X1=X1-5:IF X1<0 THEN X1=XLIMIT-X1
        IF X1<254 THEN RECT X1+64,147,XLIMIT,YLIMIT,0:GOTO NEXTI
        X=(XLIMIT-X1):RECT 64-X,147,X+64,YLIMIT,0
NEXTI:
     SYS GETIN:IF PEEK(A.REG)<>0 OR (TI>ZTIMER) THEN J=2:I=16
    NEXT
NEXT
GOSUB SWAPVERALAYERS

ENDANIM:
  GOSUB CLSGRAPH:GOSUB SETDRAWPAL:GOTO THINFONT

FIREWORKS:
  FE%=ZCVOLUME
  FOR WF=0 TO 6
   ZCVOLUME=9:IF INT(RND(.)*30)<15 THEN GOSUB SWAPVERALAYERS
   IF LAYERS.SWAPPED THEN ZCVOLUME=14
GETRANDS:
  X=INT(RND(.)*300+15):Y=INT(RND(.)*90+30):C1=X-2:C2=Y-2:C3=265-X:C4=146-Y:SIZE=INT(RND(.)*25):IF SIZE>C1 OR SIZE>C2 OR SIZE>C3 OR SIZE>C4 THEN GETRANDS
  LX=X-(SIZE+32):IF LX<0 THEN LX=0
  HX=X+(SIZE+32):IF HX>XLIMIT THEN HX=XLIMIT
  LY=Y-(SIZE+32):IF LY<0 THEN LY=0
  HY=Y+(SIZE+32):IF HY>YLIMIT THEN HY=YLIMIT
  ZCM.NUMBER=3:GOSUB ZCMPLAY:FOR J=226 TO Y STEP -1:RECT X,J,X+1,J+1, $3F:FOR I=0 TO 6:NEXT I:RECT X,J,X+1,J+1,0:NEXT J
  CD=TI+210:ZCM.NUMBER=4:GOSUB ZCMPLAY
  FOR O=0 TO 32 STEP 4
    FOR CX=0 TO 6 STEP 1.5
      B1=INT(RND(.)*SIZE)+O:B2=INT(RND(.)*SIZE)+O
      X1=X-INT(RND(.)*B1):Y1=Y-RND(.)*B2:GOSUB ADJUST
      X1=X+RND(.)*B1:Y1=Y+RND(.)*B2:GOSUB ADJUST
      X1=X+RND(.)*B1:Y1=Y-RND(.)*B2:GOSUB ADJUST
      X1=X-RND(.)*B1:Y1=Y+RND(.)*B2:GOSUB ADJUST
     NEXT CX
  NEXT O
  RECT LX,LY,HX,HY,0:GET X$:IF X$="{ESC}" THEN WF=6
  IF HX>272 THEN GOSUB SETIMAGE1
WAITZCM:
  IF TI<CD THEN WAITZCM
  NEXT WF
  ZCVOLUME=FE%:IF LAYERS.SWAPPED THEN GOSUB SWAPVERALAYERS
  RETURN

SETIMAGE1:
  X1=272:Y1=118:BLITWIDTH=64:BLITLINES=100
SPLITSET:
  F$="CELS/CELR1.BIN":GOTO GRAPHBLITIMAGE

ADJUST:
  IF X1>318 THEN X1=318
  IF X1<1 THEN X1=1
  IF Y1<1 THEN Y1=1
  IF Y1>170 THEN Y1=170
 ## C=INT(RND(.)*4)+1
 ## ON C GOTO BLUES,REDS,MAGENTAS,ORANGES
 ## BLUES:
 ##   CC=INT(RND(.)*45)+$9D:GOTO ENDADJUST
 ## REDS:
 ##   CC=INT(RND(.)*6)+$37:GOTO ENDADJUST
 ## MAGENTAS:
 ##   CC=INT(RND(.)*5)+$FA:GOTO ENDADJUST
 ## ORANGES:
 ##   CC=INT(RND(.)*20)+$44
 CC=INT(RND(.)*208)+$30
ENDADJUST:
  IF LAYERS.SWAPPED THEN RECT X1-1,Y1-1,X1+1,Y1+1,CC:RETURN
  RECT X1,Y1,X1+1,Y1+1,CC:RETURN

SWAPVERALAYERS:
  SYS $750:LAYERS.SWAPPED=NOT LAYERS.SWAPPED:RETURN


## BITBLIT IS CALLED WITH PUTIMAGE = 0 (FALSE) TO GET THE IMAGE
## IMAGE IS BUFFERED TO FILE PASSED IN F$
## SCREEN RECTANGLE TO CAPTURE IS PASSED IN X1, Y1, X2, Y2
## X2 and Y2  ** MUST ** be greater than/= X1,Y1.  IF < FUNNY
## THINGS WILL HAPPEN
##
## BITBLIT IS CALLED WITH PUTIMAGE = -1 (TRUE) TO PUT THE IMAGE
## ON THE SCREEN F$ WILL HOLD FILE NAME.
## PUT STARTING AT X1, Y1
##
## BLITWIDTH AND BLITLINES NEED TO BE SET TO THE WIDTH AND HEIGHT
## OF THE IMAGE RESPECTIVELY, NO SUCH INFO IS IN THE FILE.
##
## IF IMMEDIATELY FOLLOWING A BITBLIT GETIMAGE CALL THEN
## BLITWIDTH AND BLITLINES WILL ALREADY BE SET.
## IN THAT INSTANCE ONLY X1, Y1 NEED TO BE CHANGED
##
## X1 AND Y1 CAN BE LEFT UNCHANGED IF THE USE IS SAVING A
## SECTION OF SCREEN TO RESTORE AFTER SOMETHING ELSE IS DRAWN
##
##
## FOR THAT CASE CALL BITBLIT WITH PUTIMAGE = FALSE
## DO YOUR SCREEN STUFF
## SET PUTIMAGE TO TRUE,  CALL BITBLIT AGAIN TO RESTORE ALREADY
CHOOSEBLIT:
 IF NO.FASTBLIT THEN PUTIMAGE=TRUE:GOTO BITBLT

GRAPHBLITIMAGE:
  BLOAD F$,8,GRAPH.BANK,$A000
BLITIMAGE:
 IF X1 > 255 THEN BYTESPLIT2
  POKE R0L, X1:POKE R0H, 0:GOTO POKEY2
 BYTESPLIT2:
   POKE R0L, X1 AND $00FF:POKE R0H, 1
 POKEY2:
   POKE R1L, Y1:POKE R1H, 0
 IF BLITWIDTH>255 THEN BYTESPLIT3
    POKE R3L, BLITWIDTH:POKE R3H,0:GOTO POKEY3
 BYTESPLIT3:
    POKE R3L, BLITWIDTH AND $00FF:POKE R3H, 1
 POKEY3:
    POKE R4L, BLITLINES:POKE R4H, 0
    POKE R2L,0:POKE R2H, $A0
    BANK GRAPH.BANK:SYS GRAPH.DRAW.IMAGE:RETURN

BITBLT:
  IF PUTIMAGE THEN X$="":S$=",S,R":GOTO SKIPPER
  IF X1>X2 THEN X=X1:X1=X2:X2=X
  IF Y1>Y2 THEN X=Y1:Y1=Y2:Y2=X
  S$=",P,W":X$="@:"
SKIPPER:
  FF$=X$+F$+S$:IF PUTIMAGE THEN SET.IO=CHKIN:DO.FILEIO=MACPTR:GOTO DOSCREENBLIT
  SET.IO=CHKOUT:DO.FILEIO=MCIOUT:BLITWIDTH=(X2-X1)+1:BLITLINES=(Y2-Y1)+1
DOSCREENBLIT:
  IF Y1+BLITLINES > YLIMIT THEN BLITLINES=YLIMIT-Y1
  OPEN 2,8,2,FF$:POKE X.REG, 2:SYS SET.IO
  IF X1 > 255 THEN BYTESPLIT
  POKE R0L, X1:POKE R0H, 0:GOTO POKEY
BYTESPLIT:
  POKE R0L, X1 AND $00FF:POKE R0H, INT(X1/256)
POKEY:
  POKE R1L, Y1:POKE R1H, 0:SYS FB.CURSOR.POSITION

  FOR Y=1 TO BLITLINES
    I=0
    FOR X=1 TO 3 STEP 0
      BYTES=BLITWIDTH-I:IF BYTES>$FF THEN BYTES=$FF
      POKE A.REG, BYTES:POKE X.REG, $23:POKE Y.REG, $9F:POKE C.REG,1:SYS DO.FILEIO:I=I+PEEK(X.REG):IF I>=BLITWIDTH THEN X=3
    NEXT X
    SYS FB.CURSOR.NEXTLINE:NEXT Y
  CLOSE 2:SYS CLRCHN:RETURN

FILEEXISTS:
  X$=F$:FE%=0:X$=X$+",S,R":OPEN 2,8,2,X$:CLOSE 2:OPEN 15,8,15:INPUT#15,X,X$:CLOSE 15:FE%=(X<=20):RETURN

DRAWMSG:
  S$=" DRAWING: "+S$
PLAINMSG:
  IF LEN(S$)>38 THEN S$=LEFT$(S$,38)
  COLOR 1,0:GOSUB CLRMSG:IF IN.GAME THEN COLOR 1,4
  LOCATE 29,2:GOSUB PETCHK:IF IN.GAME THEN COLOR 1,0
  RETURN

CLRMSG:
  LOCATE 29,2:PRINT RPT$(32,38);:RETURN

BIGWORD:
  L=LEN(WD$):SX=X
  OB=PEEK(1):BANK PEEK(0),6
  FOR K=1 TO L
    CC=ASC(MID$(WD$,K,1))
    IF (CC>=64 AND CC<=90) THEN AA=64:GOTO SKIP0
    IF (CC>=97 AND CC<=122) THEN AA=-32:GOTO SKIP0
    AA=0
SKIP0:
    CA=$C000+8*(CC-AA)
    FOR I=1 TO 8
      CM(I)=PEEK(CA+(I-1)):CM$(I)=""
    NEXT I
    IF DC$="" THEN DC$=CHR$(CC)
    TD=8:IF CC=32 THEN TD=4
    FOR J=1 TO TD
        RESTORE BITMAPS
        FOR CT=1 TO 8
            READ CP
            IF (CP AND CM(J)) THEN CM$(J)=CM$(J)+DC$:GOTO SKIPSPC
            CM$(J)=CM$(J)+CHR$(32)
      SKIPSPC:
        NEXT CT
        LOCATE Y+(J-1),X:IF UC=1 THEN COLOR TC%(1,J),TC%(2,J)
        PRINT CM$(J);
    NEXT J
    IF DC$=CHR$(CC) THEN DC$=""
    X=X+TD:NEXT K
  X=SX:BANK PEEK(0),OB:RETURN

BITMAPS:
  DATA 128,64,32,16,8,4,2,1,0

HIDEALL:
  GOSUB HIDEGRAPHICS:GOTO HIDETEXT
SHOWALL:
  GOSUB SHOWGRAPHICS:GOTO SHOWTEXT

HIDEGRAPHICS:
  POKE VERA.DCVIDEO, PEEK(VERA.DCVIDEO) AND LAYER0.OFF:RETURN

SHOWGRAPHICS:
  POKE VERA.DCVIDEO, PEEK(VERA.DCVIDEO) OR LAYER0.ON:RETURN

HIDETEXT:
  POKE VERA.DCVIDEO, PEEK(VERA.DCVIDEO) AND LAYER1.OFF:RETURN

SHOWTEXT:
  POKE VERA.DCVIDEO, PEEK(VERA.DCVIDEO) OR LAYER1.ON:RETURN

RGBPAL:
  A=P1*2:X=(G%*16)+B%:A=A+$FA00:SLEEP:VPOKE 1,A,X:A=A+1:SLEEP:VPOKE 1,A,R%:RETURN

READPAL:
  A=$FA00+(P1*2):R%=VPEEK(1,A+1):GB%=VPEEK(1,A):G%=GB%/16:B%=GB% AND $0F:RETURN

PAL2PALFADE:
  GOSUB READPAL:P3=P1:P1=P2:GOSUB PALFADE:P1=P3:RETURN

PALFADE:
  DR%=R%:DG%=G%:DB%=B%:GOSUB READPAL
  RI=1:IF DR%<R% THEN RI=-1
  GI=1:IF DG%<G% THEN GI=-1
  BI=1:IF DB%<B% THEN BI=-1
  FOR X=1 TO 3 STEP 0
    IF DR%<>R% THEN R%=R%+RI
    IF DG%<>G% THEN G%=G%+GI
    IF DB%<>B% THEN B%=B%+BI
    GOSUB RGBPAL:SLEEP J
    IF DR%=R% AND DG%=G% AND DB%=B% THEN X=3
  NEXT X
FADEDONE:
  RETURN

SWAPPALET:
  A=$FA00+(P1*2):X=$FA00+(P2*2):B1=VPEEK(1,A):B2=VPEEK(1,A+1):B3=VPEEK(1,X):B4=VPEEK(1,X+1)
  VPOKE 1,A,B3:VPOKE 1,A+1,B4:VPOKE 1,X,B1:VPOKE 1,X+1,B2:RETURN

COPYPALET:
  VPOKE 1,$FA00+(P2*2),VPEEK(1,$FA00+(P1*2)):VPOKE 1,$FA00+(P2*2)+1,VPEEK(1,$FA00+(P1*2)+1):RETURN

FORCEDEFPAL:
  BVLOAD "DPAL.BIN",8,1,$FA00:RETURN
SETDEFPAL: 
  BVLOAD PF$,8,1,$FA00:RETURN

VARINIT:
  GOSUB SETDRAWCHARS:XLIMIT=319:YLIMIT=239:UC%=-1:ZCVOLUME=12:VOLUME=100:I$="SHOWCLUE":GOSUB GETINIVALUE:IF I$="0" THEN UC%=FALSE
  Q1=1:Q2=1:Q3=1:Q4=1:XSQUISH=1:YSQUISH=1:MW%=20:MC%=35:GOSUB INITALPHA:PUTIMAGE=FALSE:LEGCOLOR=$46:SHIRTCOLOR=8:BLACK2=$10:FLESHCOLOR=$25:DEC.PAL.ENTRY=$600:TWO=2
  VERA.LOWADDR=$9F20:VERA.MIDADDR=$9F21:VERA.HIGHADDR=$9F22:VERA.CTRL=$9F25

  RESTORE GAMEMENUTEXT
    FOR CX=1 TO 4
       READ S$:IF PETSCII THEN GOSUB UCASE
       MC$(CX)=S$:NEXT CX
    IF NOT FROM.MENU THEN SKIPMENUMSG
    S$="EXIT To Config Menu":IF PETSCII THEN GOSUB UCASE
    MC$(4)=S$
SKIPMENUMSG:
    DI$(1)="EASY":DI$(2)="MEDIUM":DI$(3)="HARD":RESTORE CONTROLS:FOR I=1 TO 7:FOR C=1 TO 4:READ PC%(I,C):NEXT C:NEXT I:RETURN

SETDRAWPAL:
  GOSUB SETDEFPAL:P1=FLESHCOLOR:P2=$FF:GOSUB COPYPALET:P1=1:P2=$FE:GOSUB COPYPALET:P1=$3B:P2=$FD:GOSUB COPYPALET:P1=BLACK2:P2=4:GOSUB COPYPALET:P1=$1A:P2=12:GOSUB COPYPALET:RETURN

CONTROLS:
  DATA 32,48,190,56,32,72,238,80,32,96,143,104,32,120,197,128,28,155,62,170,201,195,219,207,226,195,244,207

GAMEMENUTEXT:
  DATA "Player VS Computer","2 Player. Computer Picks","Head To Head","EXIT To Commander X16"

INITALPHA:
  FOR I=65 TO 90:AL%(1,I-64)=0:AL%(2,I-64)=I:NEXT I:RETURN

INITMUSICFILES:
  I$="MUSICDIR":GOSUB GETINIVALUE:IF I$<> "" THEN IF RIGHT$(I$,1)<>"/" THEN I$=I$+"/"
  MUSIC.DIR$=I$:I$="INTROSONG":GOSUB GETINIVALUE:I=1:GOSUB FIXMUSIC:ZNUM%(I)=0:I$="BACKGROUNDTRACK":GOSUB GETINIVALUE:I=2:GOSUB FIXMUSIC:ZNUM%(I)=0
  I$="RANDOMBGMUSIC":GOSUB GETINIVALUE:ZSM.RANDOM%(2)=(I$="1"):I$="LOSSMUSIC":GOSUB GETINIVALUE:I=3:GOSUB FIXMUSIC:ZNUM%(I)=0:ZSM.RANDOM%(3)=-1:RETURN

FIXMUSIC:
  IF I$<>"" THEN I$=MUSIC.DIR$+I$
  F$=I$:GOSUB FILEEXISTS:IF FE% THEN MUSIC.NAME$(I)=I$
  RETURN


SETREGVARS:
  A.REG=$30C:X.REG=$30D:Y.REG=$30E:C.REG=$30F:R0L=2:R0H=3:R0=R0L:R1L=4:R1H=5:R1=R1L:R2L=6:R2H=7:R2=R2L:R3L=8:R3H=9:R3=R3L:R4L=10:R4H=11:R4=R4L
  R15L=$20:R15H=$21:R15=R15L:CHKOUT=$FFC9:CHKIN=$FFC6:CLRCHN=$FFCC:MCIOUT=$FEB1:MACPTR=$FF44:GRAPH.DRAW.IMAGE=$FF38
  VERA.DCVIDEO=$9F29:LAYER0.ON=16:LAYER0.OFF=239:LAYER1.ON=32:LAYER1.OFF=223:FB.CURSOR.POSITION=$FEFF:FB.CURSOR.NEXTLINE=$FF02:TRUE=-1:FALSE=0:RETURN

LOADER:
  GOSUB PUTTOMENU:ZP.STRING$="HANGMAN.PRG":IF F$="ZSMLOADER" THEN ZP.STRING$="HANGSPLASH"
  IF F$="HANGMENU.PRG" THEN GOSUB HIDEALL
  GOSUB PUTZPSTRING:LOAD F$

GETFROMMENU:
  RA=PEEK(0):S$="":ADDR=$BF00:BANK LAST.BANK:FOR I=0 TO 7:S$=S$+CHR$(PEEK(ADDR+I)):NEXT I
  FROM.MENU=(S$="HANGMENU"):IF FROM.MENU THEN FOR I=0 TO 7:POKE ADDR+I,0:NEXT I
  BANK RA:RETURN

PUTTOMENU:
  IF NOT FROM.MENU THEN RETURN
  RA=PEEK(0):S$="HANGMENU":ADDR=$BF00:BANK LAST.BANK:FOR I=0 TO 7:POKE ADDR+I,ASC(MID$(S$,I+1,1)):NEXT I:BANK RA:RETURN

GETZPSTRING:
  X=ADDR:I=X+32:ZP.STRING$=""
ZLOOP:
  Z=PEEK(X):IF Z=0 THEN RETURN
  ZP.STRING$=ZP.STRING$ + CHR$(Z):X=X+1:IF X < I THEN ZLOOP
  RETURN

PUTZPSTRING:
   IF LEN(ZP.STRING$)=0 THEN POKE R0,0:RETURN
   ZP1=$500:FOR I=1 TO LEN(ZP.STRING$):POKE ZP1, ASC(MID$(ZP.STRING$,I,1)):ZP1=ZP1+1:NEXT I:POKE ZP1,0:RETURN

GETINIVALUE:
   I=1
GETILOOP:
   IF NN$(I)=I$ THEN I$=NV$(I):RETURN
   I=I+1:IF I>NV% THEN I$="":RETURN
   GOTO GETILOOP

READINIFROMBANK:
  VPOKE 1,$FA04,$D7:VPOKE 1,$FA05,$F:COLOR 2:BANK LAST.BANK-11:NV%=PEEK($A000):FV%=(NV%>0):ADDR=$A100
  FOR J = 1 TO NV%
      GOSUB PEEKSTRING:NV$(J)=S$:ADDR=ADDR+128
      GOSUB PEEKSTRING:NN$(J)=S$:ADDR=ADDR+128:PRINT ".";
  NEXT J
  CLS:RETURN

PEEKSTRING:
  PADDR=ADDR:S$=""
  FOR I=0 TO 2 STEP 0
      X=PEEK(PADDR)
      IF X=0 THEN I=2:GOTO PEEKEND
      IF LEN(S$)=255 AND X<>0 THEN S$="":I=2:GOTO PEEKEND
      S$=S$+CHR$(X):PADDR=PADDR+1
PEEKEND:
  NEXT I
  RETURN

READINI:
  NV%=0:FV%=0
  GOSUB FILEEXISTS:IF NOT FE% THEN RETURN
  FF$=F$+ ",S,R":OPEN 4,8,4,FF$
  DOINILOOP:
    LINPUT#4, S$
    IF LEFT$(S$,2)="##" THEN CONTLOOP
    IF LEFT$(S$,3)="REM" THEN CONTLOOP
    GOSUB TRIM:GOSUB UCASE
    IF LEFT$(S$,4)="REM " OR LEFT$(S$,2)="##" OR S$="" OR S$="REM" OR S$="##" THEN CONTLOOP
    PRINT ".";
    GOSUB GETINIVAR
    IF TN$="" THEN CONTLOOP
    IF TV$="ON" OR TV$="YES" THEN TV$="1"
    IF TV$="OFF" OR TV$="NO" THEN TV$="0"
    NV%=NV%+1:NN$(NV%)=TN$:NV$(NV%)=TV$
  CONTLOOP:
  IF ST=0 AND NV%<18 THEN DOINILOOP
  CLOSE 4:FV%=(NV%>0):PRINT:RETURN

GETINIVAR:
  SC$="":TN$="":TV$="":J=1
DOINIPARSE:
  X$=MID$(S$,J,1):IF X$="=" THEN GOTINI
  SC$=SC$+X$:J=J+1:IF J>LEN(S$) THEN ENDINI
  GOTO DOINIPARSE
GOTINI:
  J=J+1:TT$=S$:S$=SC$:SC$=""
  GOSUB RTRIM:TN$=S$:S$=TT$
VALUEPARSE:
  X$=MID$(S$,J,1):SC$=SC$+X$
  J=J+1:IF J>LEN(S$) THEN ENDINI
  GOTO VALUEPARSE
ENDINI:
  TT$=S$:S$=SC$:GOSUB TRIM:TV$=S$:S$=TT$:RETURN

PETCHK:
  IF PETSCII THEN GOSUB UCASE
  PRINT S$;:RETURN

UCASE:
  IF S$="" THEN RETURN
  X$="":FOR I=1 TO LEN(S$):I$=MID$(S$,I,1):X=ASC(I$):IF X>=97 AND X<=122 THEN X=X-32
  X$=X$+CHR$(X):NEXT I:S$=X$:RETURN

TRIM:
  GOSUB LTRIM:GOTO RTRIM

LTRIM:
   IF S$="" THEN RETURN
   I=1:C1=0
DOLOOP:
   X$=MID$(S$,I,1):X=ASC(X$):IF X > 32 THEN LSTR
   C1=C1+1:I=I+1:IF I>LEN(S$) THEN LSTR
   GOTO DOLOOP
LSTR:
   IF C1=LEN(S$) THEN S$=""
   IF C1>0 AND C1<LEN(S$) THEN S$=MID$(S$,C1+1,LEN(S$)-C1)
   RETURN

RTRIM:
  IF S$="" THEN RETURN
  I=LEN(S$):C1=0
DOLOOPR:
  X$=MID$(S$,I,1):X=ASC(X$):IF X>32 THEN RSTR
  C1=C1+1:I=I-1:IF I<1 THEN RSTR
  GOTO DOLOOPR
RSTR:
  IF C1=LEN(S$) THEN S$=""
  IF C1>0 AND C1<LEN(S$) THEN S$=MID$(S$,1,LEN(S$)-C1)
  RETURN

CLSGRAPH:
  GOSUB HIDEALL:COLOR 1,0:CLS:RECT 0,0,XLIMIT,YLIMIT,0:RETURN

ERRORHALT:
  CLS:P1=5:R%=0:G%=14:B%=2:GOSUB RGBPAL:P1=15:R%=2:G%=2:GOSUB RGBPAL:P1=1:R%=15:G%=15:B%=15:GOSUB RGBPAL
  PRINT "{CR}{CR}{YEL}  ERROR ENCOUNTERED{WHT}!":PRINT ":{GRN} {CR}";S$;"{WHT}{CR}":GOSUB SHOWALL:END

CLEANUP:
  GOSUB CLSGRAPH:F$="CREDITS.PRG":IF FROM.MENU THEN GOSUB PAUSEMUSIC:F$="CONFMENU.PRG"
  IF F$="CREDITS.PRG" THEN GOSUB SHOWALL
  GOSUB CLEARMEM:LOAD F$

THINFONT:
 IF ISO.ON THEN FONTFILE$=FONT1$:GOSUB LOADISOFONT:GOTO FONTEND
 POKE A.REG,4:GOTO FONTSYS

THICKFONT:
 IF ISO.ON THEN FONTFILE$=FONT2$:GOSUB LOADISOFONT:GOTO FONTEND
 POKE A.REG,2
FONTSYS:
 SYS $FF62
FONTEND:
 GOSUB BLOCKFROWN:RETURN

CLEARMEM:
  FOR A=R0L TO R15H:POKE A,0:NEXT A
  FOR A=$400 TO $40A:POKE A,0:NEXT A
  RETURN
